<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="app.title">Rapports Commerciaux</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2196F3">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“‹</text></svg>">
    <link rel="stylesheet" href="css/styles.css">
    
    <style>
        /* SÃ©lecteur de langue sur page LOGIN */
        .login-language-selector {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .language-btn-login {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 16px;
            border-radius: 12px;
            border: 2px solid rgba(139, 21, 56, 0.2);
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .language-btn-login:hover {
            background: white;
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .language-btn-login .arrow {
            font-size: 10px;
            transition: transform 0.3s;
        }
        
        .language-btn-login.active .arrow {
            transform: rotate(180deg);
        }
        
        .language-dropdown-login {
            position: absolute;
            top: 60px;
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
            min-width: 200px;
            border: 1px solid rgba(0,0,0,0.1);
        }
        
        .language-dropdown-login .lang-option {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
            text-align: left;
        }
        
        .language-dropdown-login .lang-option:hover {
            background: rgba(139, 21, 56, 0.05);
        }
        
        .language-dropdown-login .lang-option span {
            font-weight: 500;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .login-language-selector {
                top: 10px;
                right: 10px;
            }
            
            .language-btn-login {
                padding: 8px 12px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header" id="header">
            <!-- LOGO VOCALIA avec dÃ©gradÃ© -->
            <div class="app-logo">
                <span class="logo-text">VOCALIA</span>
            </div>
            
            <div class="user-info">
                <div class="avatar" id="userAvatar">U</div>
                <div>
                    <div id="userName">Utilisateur</div>
                    <div class="user-role" id="userRole">Commercial</div>
                </div>
            </div>
            <div class="nav-buttons">
                <button class="nav-btn" id="navBrouillon" data-i18n="nav.drafts">ğŸ“ Brouillons</button>
                <button class="nav-btn" id="navRapports" data-i18n="nav.reports">ğŸ“Š Rapports</button>
                
                <!-- SÃ©lecteur de langue -->
                <div class="language-selector">
                    <button class="language-btn" id="currentLanguageBtn" onclick="toggleLanguageDropdown()">
                        <span id="currentFlag">ğŸ‡«ğŸ‡·</span>
                        <span id="currentLangCode">FR</span>
                        <span class="arrow">â–¼</span>
                    </button>
                    
                    <div class="language-dropdown" id="languageDropdown" style="display: none;">
                        <button class="lang-option" onclick="changeLanguage('fr')">
                            ğŸ‡«ğŸ‡· <span>FranÃ§ais</span>
                        </button>
                        <button class="lang-option" onclick="changeLanguage('en')">
                            ğŸ‡¬ğŸ‡§ <span>English</span>
                        </button>
                        <button class="lang-option" onclick="changeLanguage('cn')">
                            ğŸ‡¨ğŸ‡³ <span>ä¸­æ–‡</span>
                        </button>
                        <button class="lang-option" onclick="changeLanguage('jp')">
                            ğŸ‡¯ğŸ‡µ <span>æ—¥æœ¬èª</span>
                        </button>
                    </div>
                </div>
                
                <button class="nav-btn" id="navProfil" data-i18n="nav.profile">ğŸ‘¤ Profil</button>
                <button class="nav-btn logout" id="logoutBtn" data-i18n="nav.logout">ğŸšª</button>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div id="mainContent">
            
            <!-- PAGE LOGIN -->
            <div class="page login-page" id="loginPage" style="display: block;">
                <!-- SÃ‰LECTEUR DE LANGUE SUR LA PAGE LOGIN -->
                <div class="login-language-selector">
                    <button class="language-btn-login" id="loginLanguageBtn" onclick="toggleLoginLanguageDropdown()">
                        <span id="loginCurrentFlag">ğŸ‡«ğŸ‡·</span>
                        <span id="loginCurrentCode">FR</span>
                        <span class="arrow">â–¼</span>
                    </button>
                    
                    <div class="language-dropdown-login" id="loginLanguageDropdown" style="display: none;">
                        <button class="lang-option" onclick="changeLoginLanguage('fr')">
                            ğŸ‡«ğŸ‡· <span>FranÃ§ais</span>
                        </button>
                        <button class="lang-option" onclick="changeLoginLanguage('en')">
                            ğŸ‡¬ğŸ‡§ <span>English</span>
                        </button>
                        <button class="lang-option" onclick="changeLoginLanguage('cn')">
                            ğŸ‡¨ğŸ‡³ <span>ä¸­æ–‡</span>
                        </button>
                        <button class="lang-option" onclick="changeLoginLanguage('jp')">
                            ğŸ‡¯ğŸ‡µ <span>æ—¥æœ¬èª</span>
                        </button>
                    </div>
                </div>
                
                <div class="logo">ğŸ¢</div>
                <div class="brand-tagline">
                    <h1 data-i18n="login.title">Connexion</h1>
                    <p class="tagline" data-i18n="login.tagline">Du code et de l'IA pour donner vie Ã  vos rapports</p>
                </div>
                <form id="loginForm">
                    <div class="form-group">
                        <label for="username" data-i18n="login.username">ğŸ‘¤ Email</label>
                        <input type="text" id="username" name="username" required autocomplete="username">
                    </div>
                    <div class="form-group">
                        <label for="password" data-i18n="login.password">ğŸ”’ Mot de passe</label>
                        <input type="password" id="password" name="password" required autocomplete="current-password">
                    </div>
                    <button type="submit" class="login-btn" id="loginBtn" data-i18n="login.button">Se connecter</button>
                    
                    <!-- NOUVEAU : Lien vers inscription -->
                    <div class="register-link" style="text-align: center; margin-top: 20px; font-size: 14px; color: #666;">
                        <span data-i18n="login.no.account">Pas encore de compte ?</span>
                        <a href="register.html" style="color: var(--primary); text-decoration: none; font-weight: 600; margin-left: 5px;" data-i18n="login.create.account">CrÃ©er un compte gratuit</a>
                    </div>
                    
                    <div class="error-message" id="errorMessage"></div>
                    <div class="loading" id="loadingMessage">
                        <div class="loading-spinner"></div>
                        <span data-i18n="login.loading">Connexion en cours...</span>
                    </div>
                </form>
            </div>

            <!-- PAGE BROUILLON -->
            <div class="page" id="brouillonPage" style="display: none;">
                <h1 data-i18n="drafts.title">ğŸ“ Brouillons</h1>
                
                <!-- Section Enregistrement -->
                <div class="recording-section">
                    <h3 data-i18n="drafts.create">ğŸ¤ CrÃ©er un nouveau rapport</h3>
                    
                    <!-- Options d'ajout -->
                    <div class="input-options">
                        <div class="option-group">
                            <h4 data-i18n="drafts.record">Enregistrer un vocal</h4>
                            <div class="record-button" id="recordBtn">âºï¸</div>
                            <div id="recordingStatus" data-i18n="drafts.record.button">Appuyer pour enregistrer</div>
                            
                            <div class="audio-controls" id="audioControls">
                                <button class="audio-btn" id="playBtn" data-i18n="drafts.record.play">â–¶ï¸ Ã‰couter</button>
                                <button class="audio-btn" id="reRecordBtn" data-i18n="drafts.record.redo">ğŸ”„ Refaire</button>
                            </div>
                        </div>
                        
                        <div class="option-divider" data-i18n="drafts.or">OU</div>
                        
                        <div class="option-group">
                            <h4 data-i18n="drafts.upload">Importer un fichier audio</h4>
                            <!-- âœ… CORRECTION iOS : SpÃ©cifier explicitement tous les formats audio -->
                            <input type="file" id="audioFileInput" 
                                   accept="audio/mpeg,audio/mp3,audio/wav,audio/x-wav,audio/mp4,audio/m4a,audio/x-m4a,audio/aac,audio/ogg,audio/webm,audio/flac,audio/*" 
                                   style="display: none;">
                            <button class="upload-btn" id="uploadBtn" data-i18n="drafts.upload.button">ğŸ“ Choisir un fichier</button>
                            <div id="uploadStatus"></div>
                        </div>
                    </div>
                    
                    <button class="send-btn" id="sendAudioBtn" data-i18n="drafts.send">ğŸ“¤ Envoyer pour traitement</button>
                </div>

                <!-- Liste des brouillons -->
                <div>
                    <h3 data-i18n="drafts.list.title">ğŸ“‹ Rapports en attente de validation :</h3>
                    <div class="reports-list" id="brouillonsList">
                        <div class="empty-state">
                            <div class="icon">ğŸ“„</div>
                            <p data-i18n="drafts.empty">Aucun brouillon pour le moment</p>
                            <p class="empty-subtitle" data-i18n="drafts.empty.subtitle">Enregistrez ou importez votre premier rapport vocal !</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PAGE RAPPORTS -->
            <div class="page" id="rapportsPage" style="display: none;">
                <h1 data-i18n="reports.title">ğŸ“Š Rapports finalisÃ©s</h1>
                
                <!-- Section Recherche -->
                <div class="search-section">
                    <input type="text" class="search-input" id="searchInput" data-i18n-placeholder="reports.search" placeholder="ğŸ” Rechercher un rapport...">
                </div>

                <!-- Stats avec bouton crÃ©er dossier -->
                <div class="stats-section" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                    <div style="display: flex; gap: 30px; flex-wrap: wrap;">
                        <span><span data-i18n="reports.stats" data-i18n-params='{"count":""}'>âœ… Rapports validÃ©s :</span> <span id="rapportsCount">0</span></span>
                        <span><span data-i18n="reports.stats.pdf" data-i18n-params='{"count":""}'>ğŸ“„ PDF gÃ©nÃ©rÃ©s :</span> <span id="pdfCount">0</span></span>
                    </div>
                    <button class="action-btn" id="createFolderBtnTop" style="background: var(--gradient-main); color: white; padding: 10px 20px; border-radius: 20px; font-weight: 600; font-size: 13px; box-shadow: 0 2px 10px rgba(37, 99, 235, 0.3); transition: all 0.3s ease;" 
                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(37, 99, 235, 0.4)';" 
                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 10px rgba(37, 99, 235, 0.3)';"
                            onclick="window.dataManager.showCreateFolderModal()">
                        â• <span data-i18n="folder.create.button">CrÃ©er un dossier</span>
                    </button>
                </div>

                <!-- Liste des rapports -->
                <div class="reports-list" id="rapportsList">
                    <div class="empty-state">
                        <div class="icon">ğŸ“‹</div>
                        <p data-i18n="reports.empty">Aucun rapport finalisÃ©</p>
                        <p class="empty-subtitle" data-i18n="reports.empty.subtitle">Validez vos brouillons pour les voir ici !</p>
                    </div>
                </div>
            </div>

            <!-- ğŸ‘¤ PAGE PROFIL - VERSION CORRIGÃ‰E -->
            <div id="profilPage" class="page-content" style="display: none;">
                <div class="page-header">
                    <h2 data-i18n="profile.title">Mon Profil</h2>
                </div>

                <!-- Informations personnelles -->
                <div class="profile-section">
                    <h3 data-i18n="profile.info">Informations personnelles</h3>
                    
                    <div class="form-group">
                        <label data-i18n="profile.firstname">PrÃ©nom</label>
                        <input type="text" id="profileFirstName" class="input-field" placeholder="Jean">
                    </div>
                    
                    <div class="form-group">
                        <label data-i18n="profile.lastname">Nom</label>
                        <input type="text" id="profileLastName" class="input-field" placeholder="Dupont">
                    </div>
                    
                    <div class="form-group">
                        <label data-i18n="profile.email">Email</label>
                        <input type="email" id="profileEmail" class="input-field" placeholder="jean.dupont@example.com" readonly>
                    </div>
                    
                    <button id="saveProfileBtn" class="btn-primary" onclick="window.appManager.profileManager.saveProfile()" style="margin-top: 20px;">
                        ğŸ’¾ <span data-i18n="profile.save">Sauvegarder</span>
                    </button>
                </div>

                <!-- Mon abonnement -->
                <div class="profile-section">
                    <h3 data-i18n="profile.subscription">Mon abonnement</h3>
                    
                    <div id="planBadge" class="plan-badge free">FREE</div>
                    <div id="planDate" style="margin: 15px 0; color: var(--gray-600); font-size: 14px;">Membre depuis...</div>
                    
                    <!-- Compteur rapports -->
                    <div style="margin: 20px 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-weight: 600; color: var(--gray-800);" data-i18n="profile.reports.month">Rapports ce mois</span>
                            <span style="font-weight: 700; font-size: 18px; color: var(--success);">
                                <span id="reportsCountProfile">0</span>/<span id="reportsLimitProfile">5</span>
                            </span>
                        </div>
                        
                        <!-- Barre de progression -->
                        <div style="width: 100%; height: 12px; background: var(--gray-200); border-radius: 10px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);">
                            <div id="reportsProgressBar" style="
                                width: 0%; 
                                height: 100%; 
                                background: linear-gradient(90deg, #8B1538, #F59E0B); 
                                transition: all 0.3s ease;
                                border-radius: 10px;
                            "></div>
                        </div>
                    </div>
                    
                    <!-- âœ… CONTENEUR POUR LA DATE DU PROCHAIN RESET -->
                    <div id="nextResetInfo"></div>
                    
                    <!-- âœ… BOUTON UPGRADE (pour utilisateurs FREE) -->
                    <button id="upgradeBtn" class="btn-primary" onclick="window.appManager.profileManager.handleUpgrade()" style="
                        width: 100%;
                        margin-top: 20px;
                        padding: 14px;
                        background: linear-gradient(135deg, var(--primary), #FF6F00);
                        color: white;
                        border: none;
                        border-radius: 12px;
                        font-weight: 700;
                        cursor: pointer;
                        font-size: 15px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 8px;
                        transition: all 0.3s ease;
                        box-shadow: 0 4px 15px rgba(139, 21, 56, 0.3);
                    ">
                        <span data-i18n="profile.upgrade.pro">âœ¨ ğŸš€ Passer au plan PRO</span>
                    </button>
                    
                    <!-- âœ… NOUVEAU : BOUTON ANNULER (pour utilisateurs PRO) -->
                    <button id="cancelSubscriptionBtn" class="btn-danger" onclick="window.appManager.profileManager.cancelSubscription()" style="
                        width: 100%;
                        margin-top: 20px;
                        padding: 14px;
                        background: linear-gradient(135deg, #DC2626, #991B1B);
                        color: white;
                        border: none;
                        border-radius: 12px;
                        font-weight: 700;
                        cursor: pointer;
                        font-size: 15px;
                        display: none;
                        align-items: center;
                        justify-content: center;
                        gap: 8px;
                        transition: all 0.3s ease;
                        box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
                    ">
                        <span data-i18n="profile.cancel">ğŸš« Annuler l'abonnement</span>
                    </button>
                </div>

                <!-- Appareils connectÃ©s -->
                <div class="profile-section">
                    <h3 data-i18n="profile.devices">Appareils connectÃ©s</h3>
                    <div id="devicesList"></div>
                </div>

                <!-- Bouton supprimer le compte -->
                <div class="profile-section">
                    <button id="deleteAccountBtn" onclick="window.appManager.profileManager.deleteAccount()" data-i18n="profile.delete.account">
                        Supprimer mon compte
                    </button>
                </div>
            </div>

        </div>
    </div>

    <!-- ============================================ -->
    <!-- SCRIPTS - ORDRE IMPORTANT ! -->
    <!-- ============================================ -->
    
    <!-- 1. Supabase Client Library (DOIT ÃŠTRE EN PREMIER) -->
    <script src="js/supabase.min.js"></script>
    <script src="js/stripe-config.js"></script>
    
    <!-- 2. Configuration Supabase -->
    <script src="js/supabase-config.js"></script>
    
    <!-- 3. Configuration de l'app -->
    <script src="js/config.js"></script>
    
    <!-- 4. SystÃ¨me de traductions -->
    <script src="js/translations.js"></script>
    <script src="js/language-manager.js"></script>
    
    <!-- 5. Utilitaires -->
    <script src="js/utils.js"></script>
    
    <!-- 6. Configuration Stripe (IMPORTANT : AVANT profile-manager) -->
    <script src="js/stripe-config.js"></script>
    
    <!-- 7. Managers de l'application -->
    <script src="js/audio-manager.js"></script>
    <script src="js/data-manager.js"></script>
    <script src="js/profile-manager.js"></script>
    <script src="js/app.js"></script>
    
    <!-- ============================================ -->
    <!-- EFFETS VISUELS -->
    <!-- ============================================ -->
    
    <!-- Effet de particules pour la page de connexion -->
    <script>
        // Effet de particules subtil pour la page de connexion
        function createNetworkEffect() {
            const loginPage = document.getElementById('loginPage');
            if (!loginPage || loginPage.style.display === 'none') return;
            
            const particles = document.createElement('div');
            particles.className = 'network-particles';
            particles.style.cssText = `
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                pointer-events: none;
                z-index: 0;
            `;
            
            // CrÃ©er quelques particules subtiles
            for (let i = 0; i < 8; i++) {
                const particle = document.createElement('div');
                particle.style.cssText = `
                    position: absolute;
                    width: 4px;
                    height: 4px;
                    background: rgba(255, 255, 255, 0.3);
                    border-radius: 50%;
                    top: ${Math.random() * 100}%;
                    left: ${Math.random() * 100}%;
                    animation: particleFloat ${3 + Math.random() * 4}s ease-in-out infinite;
                    animation-delay: ${Math.random() * 2}s;
                `;
                particles.appendChild(particle);
            }
            
            loginPage.appendChild(particles);
        }
        
        // Ajouter l'animation CSS pour les particules
        const particleStyle = document.createElement('style');
        particleStyle.textContent = `
            @keyframes particleFloat {
                0%, 100% { 
                    transform: translateY(0px) translateX(0px);
                    opacity: 0.3;
                }
                50% { 
                    transform: translateY(-20px) translateX(10px);
                    opacity: 0.8;
                }
            }
        `;
        document.head.appendChild(particleStyle);
        
        // Initialiser l'effet au chargement
        document.addEventListener('DOMContentLoaded', createNetworkEffect);
    </script>

    <!-- ============================================ -->
    <!-- SERVICE WORKER (PWA) -->
    <!-- ============================================ -->
    
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('âœ… Service Worker enregistrÃ©');
                    })
                    .catch(err => {
                        console.log('âŒ Ã‰chec enregistrement Service Worker:', err);
                    });
            });
        }
    </script>
    
    <script>
        // ===== GESTION DU SÃ‰LECTEUR DE LANGUE SUR PAGE LOGIN =====
        
        function toggleLoginLanguageDropdown() {
            const dropdown = document.getElementById('loginLanguageDropdown');
            const btn = document.getElementById('loginLanguageBtn');
            
            if (!dropdown) return;
            
            const isVisible = dropdown.style.display === 'block';
            dropdown.style.display = isVisible ? 'none' : 'block';
            btn?.classList.toggle('active', !isVisible);
        }
        
        function changeLoginLanguage(langCode) {
            if (window.languageManager) {
                window.languageManager.setLanguage(langCode);
                
                // Mettre Ã  jour le bouton du login
                const flags = { fr: 'ğŸ‡«ğŸ‡·', en: 'ğŸ‡¬ğŸ‡§', cn: 'ğŸ‡¨ğŸ‡³', jp: 'ğŸ‡¯ğŸ‡µ' };
                const codes = { fr: 'FR', en: 'EN', cn: 'CN', jp: 'JP' };
                
                const loginFlag = document.getElementById('loginCurrentFlag');
                const loginCode = document.getElementById('loginCurrentCode');
                
                if (loginFlag) loginFlag.textContent = flags[langCode];
                if (loginCode) loginCode.textContent = codes[langCode];
            }
            
            // Fermer le dropdown
            const dropdown = document.getElementById('loginLanguageDropdown');
            if (dropdown) dropdown.style.display = 'none';
            
            const btn = document.getElementById('loginLanguageBtn');
            if (btn) btn.classList.remove('active');
        }
        
        // Fermer le dropdown au clic extÃ©rieur (seulement pour login)
        document.addEventListener('click', (e) => {
            const selector = document.querySelector('.login-language-selector');
            const dropdown = document.getElementById('loginLanguageDropdown');
            const btn = document.getElementById('loginLanguageBtn');
            
            if (selector && !selector.contains(e.target) && dropdown && btn) {
                dropdown.style.display = 'none';
                btn.classList.remove('active');
            }
        });
        
        // Initialiser le sÃ©lecteur de langue au chargement
        window.addEventListener('DOMContentLoaded', () => {
            if (window.languageManager) {
                const currentLang = window.languageManager.getCurrentLanguage();
                changeLoginLanguage(currentLang);
            }
        });
    </script>
</body>
</html>